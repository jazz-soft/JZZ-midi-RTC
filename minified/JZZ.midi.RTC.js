(t=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=t.RTC=t:"function"==typeof define&&define.amd?define("JZZ.midi.RTC",["JZZ"],t):t(JZZ)})(function(h){var n;function t(t){this.pref=(t=>{if(null==t){t="WebRTC";for(var i=1;n[t];i++)t="WebRTC"+i}return n[t]=!0,t})(t),this.ins={},this.outs={},this.inputs=[],this.outputs=[]}function e(t){return JSON.stringify({info:{inputs:t.inputs,outputs:t.outputs}})}function s(t,i){t.chan&&t.chan.send(i)}function p(t){for(var i={midi:t.splice(0,t.length)},n=Object.keys(t),e=0;e<n.length;e++)"length"!=n[e]&&"_from"!=n[e]&&(i[n[e]]=t[n[e]]);return i}function a(t){for(var i=new h.MIDI(t.midi),n=Object.keys(t),e=0;e<n.length;e++)"midi"!=n[e]&&(i[n[e]]=n[n[e]]);return i}function l(t,i){for(var n=[],e=[],s=0;s<t.length;s++)i.includes(t[s])||n.push(t[s]);for(s=0;s<i.length;s++)t.includes(i[s])||e.push(i[s]);return[n,e]}h.RTC||(n={},t.prototype.connect=function(t){var d=this,i=t.createDataChannel("MIDI"),r={},u={},c=[],f=[];i.addEventListener("open",function(){d.chan=i,s(d,e(d))}),i.addEventListener("close",function(){d.chan=void 0}),i.addEventListener("message",function(t){try{var i=JSON.parse(t.data);i.midi&&d.outs[i.id]&&d.outs[i.id].send(a(i.midi))}catch(t){}}),t.addEventListener("datachannel",function(t){var o=t.channel;"MIDI"==o.label&&(o.addEventListener("close",function(){for(var t=0;t<c.length;t++)r[c[t]].disconnect(),h.removeMidiIn(d.pref+" - "+c[t]);for(t=0;t<f.length;t++)u[f[t]].disconnect(),h.removeMidiOut(d.pref+" - "+f[t]);r={},u={},c=[],f=[]}),o.addEventListener("message",function(t){try{var i=JSON.parse(t.data);if(i.info){for(var n,e=l(i.info.inputs,c),s=0;s<e[0].length;s++)n=new h.Widget({_info:{type:"rtc"}}),r[e[0][s]]=n,h.addMidiIn(d.pref+" - "+e[0][s],n);for(s=0;s<e[1].length;s++)r[e[1][s]].disconnect(),delete r[e[1][s]],h.removeMidiIn(d.pref+" - "+e[1][s]);for(e=l(i.info.outputs,f),s=0;s<e[0].length;s++)n=new h.Widget({_receive:((i,n)=>function(t){i.send(JSON.stringify({id:n,midi:p(t)}))})(o,e[0][s]),_info:{type:"rtc"}}),u[e[0][s]]=n,h.addMidiOut(d.pref+" - "+e[0][s],n);for(s=0;s<e[1].length;s++)u[e[1][s]].disconnect(),delete u[e[1][s]],h.removeMidiOut(d.pref+" - "+e[1][s]);c=i.info.inputs,f=i.info.outputs}else i.midi&&r[i.id]&&r[i.id].send(a(i.midi))}catch(t){console.error(t.message)}}))})},t.prototype.close=function(){},t.prototype.addMidiIn=function(i,t){var n;this.ins[i]||(this.ins[i]=t,this.inputs.push(i),n=this,t.connect(function(t){s(n,JSON.stringify({id:i,midi:p(t)}))}),s(this,e(this)))},t.prototype.addMidiOut=function(t,i){this.outs[t]||(this.outs[t]=i,this.outputs.push(t),s(this,e(this)))},t.prototype.removeMidiIn=function(t){var i=this.inputs.indexOf(t);-1!=i&&(this.inputs.splice(i,1),this.ins[t].disconnect(),delete this.ins[t],s(this,e(this)))},t.prototype.removeMidiOut=function(t){var i=this.outputs.indexOf(t);-1!=i&&(this.outputs.splice(i,1),this.outs[t].disconnect(),delete this.outs[t],s(this,e(this)))},h.RTC=t)});